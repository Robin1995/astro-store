---
import MainLayout from "@/layouts/MainLayout.astro";
import { actions } from "astro:actions";
import Pagination from "@/components/shared/Pagination.astro";
import { Formatter } from "@/utils";
import ProductImage from "@/components/products/ProductImage.astro";
const url = Astro.url;
const pageParam = Number(url.searchParams.get("page") ?? 1);

const { data: products, error } = await Astro.callAction(
  actions.getProductsByPage,
  { page: pageParam }
);

if (error) {
  return Astro.redirect("/");
}

const { products: productsList, totalPages } = products;
---

<MainLayout>
  <h1>Dashboard</h1>
  <p>Listado de productos</p>

  <div class="flex justify-end">
    <a
      href="/admin/products/new"
      class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 transition-all"
      >Crear nuevo producto</a
    >
  </div>

  <table class="w-full mt-5">
    <thead>
      <tr>
        <th class="text-left">Imagen</th>
        <th class="text-left">Titulo</th>
        <th class="text-left">Precio</th>
        <th class="text-left">Inventario</th>
      </tr>
    </thead>
    <tbody>
      {
        productsList.map((product) => (
          <tr>
            <td>
              <ProductImage
                className="w-20 h-20 object-cover"
                src={product.images.split(",")[0]}
                alt={product.title}
              />
            </td>
            <td>
              <a
                class="hover:underline cursor-pointer"
                href={`/admin/products/${product.slug}`}
              >
              {product.title}
              </a>
            </td>
            <td>{Formatter.currency(product.price)}</td>
            <td> {product.stock}</td>
          </tr>
        ))
      }
    </tbody>
  </table>
  <Pagination totalPages={totalPages} />
</MainLayout>
